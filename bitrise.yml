workflows:
  ios:
    name: iOS Workflow
    instance_type: mac_mini
    max_build_duration: 60
    environment:
      vars:
        MY_VAR: 'value'

    scripts:
      # Шаг 1: Установка зависимостей через Swift Package Manager
      - name: Resolve Swift dependencies
        script: |
          swift package resolve

      # Шаг 2: Сборка проекта через Swift Package Manager
      - name: Build project with Swift Package Manager
        script: |
          swift build

      # Шаг 3: Архивация приложения через xcodebuild
      - name: Archive app with xcodebuild
        script: |
          xcodebuild archive -scheme my-swift-project -sdk iphoneos -archivePath $PWD/build/my-swift-project.xcarchive

      # Шаг 4: Экспорт IPA
      - name: Export IPA from archive
        script: |
          xcodebuild -exportArchive -archivePath $PWD/build/my-swift-project.xcarchive -exportOptionsPlist $PWD/ExportOptions.plist -exportPath $PWD/build

      # Шаг 5: Проверка наличия IPA
      - name: Check if IPA file exists
        script: |
          if [ -f "$PWD/build/my-swift-project.ipa" ]; then
            echo "IPA file found!"
          else
            echo "IPA file not found!"
            exit 1  # Завершаем сборку с ошибкой, если файл не найден
          fi

      # Шаг 6: Загрузка IPA как артефакт
      - name: Upload IPA as build artifact
        script: |
          echo "Uploading IPA artifact"
          mv $PWD/build/my-swift-project.ipa $BITRISE_DEPLOY_DIR/
